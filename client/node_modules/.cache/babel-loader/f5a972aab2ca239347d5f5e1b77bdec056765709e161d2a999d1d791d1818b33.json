{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n  return r;\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar graphql_1 = require(\"graphql\");\nvar transforms_1 = require(\"../transforms/transforms\");\nvar AddArgumentsAsVariables_1 = require(\"../transforms/AddArgumentsAsVariables\");\nvar FilterToSchema_1 = require(\"../transforms/FilterToSchema\");\nvar AddTypenameToAbstract_1 = require(\"../transforms/AddTypenameToAbstract\");\nvar CheckResultAndHandleErrors_1 = require(\"../transforms/CheckResultAndHandleErrors\");\nvar mapAsyncIterator_1 = require(\"./mapAsyncIterator\");\nvar ExpandAbstractTypes_1 = require(\"../transforms/ExpandAbstractTypes\");\nvar ReplaceFieldWithFragment_1 = require(\"../transforms/ReplaceFieldWithFragment\");\nvar ConvertEnumResponse_1 = require(\"../transforms/ConvertEnumResponse\");\nfunction delegateToSchema(options) {\n  var args = [];\n  for (var _i = 1; _i < arguments.length; _i++) {\n    args[_i - 1] = arguments[_i];\n  }\n  if (options instanceof graphql_1.GraphQLSchema) {\n    throw new Error('Passing positional arguments to delegateToSchema is a deprecated. ' + 'Please pass named parameters instead.');\n  }\n  return delegateToSchemaImplementation(options);\n}\nexports.default = delegateToSchema;\nfunction delegateToSchemaImplementation(options) {\n  return __awaiter(this, void 0, void 0, function () {\n    var info, _a, args, operation, rawDocument, rawRequest, transforms, processedRequest, errors, _b, executionResult;\n    return __generator(this, function (_c) {\n      switch (_c.label) {\n        case 0:\n          info = options.info, _a = options.args, args = _a === void 0 ? {} : _a;\n          operation = options.operation || info.operation.operation;\n          rawDocument = createDocument(options.fieldName, operation, info.fieldNodes, Object.keys(info.fragments).map(function (fragmentName) {\n            return info.fragments[fragmentName];\n          }), info.operation.variableDefinitions, info.operation.name);\n          rawRequest = {\n            document: rawDocument,\n            variables: info.variableValues\n          };\n          transforms = __spreadArrays(options.transforms || [], [new ExpandAbstractTypes_1.default(info.schema, options.schema)]);\n          if (info.mergeInfo && info.mergeInfo.fragments) {\n            transforms.push(new ReplaceFieldWithFragment_1.default(options.schema, info.mergeInfo.fragments));\n          }\n          transforms = transforms.concat([new AddArgumentsAsVariables_1.default(options.schema, args), new FilterToSchema_1.default(options.schema), new AddTypenameToAbstract_1.default(options.schema), new CheckResultAndHandleErrors_1.default(info, options.fieldName)]);\n          if (graphql_1.isEnumType(options.info.returnType)) {\n            transforms = transforms.concat(new ConvertEnumResponse_1.default(options.info.returnType));\n          }\n          processedRequest = transforms_1.applyRequestTransforms(rawRequest, transforms);\n          if (!options.skipValidation) {\n            errors = graphql_1.validate(options.schema, processedRequest.document);\n            if (errors.length > 0) {\n              throw errors;\n            }\n          }\n          if (!(operation === 'query' || operation === 'mutation')) return [3 /*break*/, 2];\n          _b = transforms_1.applyResultTransforms;\n          return [4 /*yield*/, graphql_1.execute(options.schema, processedRequest.document, info.rootValue, options.context, processedRequest.variables)];\n        case 1:\n          return [2 /*return*/, _b.apply(void 0, [_c.sent(), transforms])];\n        case 2:\n          if (!(operation === 'subscription')) return [3 /*break*/, 4];\n          return [4 /*yield*/, graphql_1.subscribe(options.schema, processedRequest.document, info.rootValue, options.context, processedRequest.variables)];\n        case 3:\n          executionResult = _c.sent();\n          // \"subscribe\" to the subscription result and map the result through the transforms\n          return [2 /*return*/, mapAsyncIterator_1.default(executionResult, function (result) {\n            var _a;\n            var transformedResult = transforms_1.applyResultTransforms(result, transforms);\n            var subscriptionKey = Object.keys(result.data)[0];\n            // for some reason the returned transformedResult needs to be nested inside the root subscription field\n            // does not work otherwise...\n            return _a = {}, _a[subscriptionKey] = transformedResult, _a;\n          })];\n        case 4:\n          return [2 /*return*/];\n      }\n    });\n  });\n}\n\nfunction createDocument(targetField, targetOperation, originalSelections, fragments, variables, operationName) {\n  var selections = [];\n  var args = [];\n  originalSelections.forEach(function (field) {\n    var fieldSelections = field.selectionSet ? field.selectionSet.selections : [];\n    selections = selections.concat(fieldSelections);\n    args = args.concat(field.arguments || []);\n  });\n  var selectionSet = null;\n  if (selections.length > 0) {\n    selectionSet = {\n      kind: graphql_1.Kind.SELECTION_SET,\n      selections: selections\n    };\n  }\n  var rootField = {\n    kind: graphql_1.Kind.FIELD,\n    alias: null,\n    arguments: args,\n    selectionSet: selectionSet,\n    name: {\n      kind: graphql_1.Kind.NAME,\n      value: targetField\n    }\n  };\n  var rootSelectionSet = {\n    kind: graphql_1.Kind.SELECTION_SET,\n    selections: [rootField]\n  };\n  var operationDefinition = {\n    kind: graphql_1.Kind.OPERATION_DEFINITION,\n    operation: targetOperation,\n    variableDefinitions: variables,\n    selectionSet: rootSelectionSet,\n    name: operationName\n  };\n  return {\n    kind: graphql_1.Kind.DOCUMENT,\n    definitions: __spreadArrays([operationDefinition], fragments)\n  };\n}","map":{"version":3,"names":["graphql_1","require","transforms_1","AddArgumentsAsVariables_1","FilterToSchema_1","AddTypenameToAbstract_1","CheckResultAndHandleErrors_1","mapAsyncIterator_1","ExpandAbstractTypes_1","ReplaceFieldWithFragment_1","ConvertEnumResponse_1","delegateToSchema","options","args","_i","arguments","length","GraphQLSchema","Error","delegateToSchemaImplementation","exports","default","info","_a","operation","rawDocument","createDocument","fieldName","fieldNodes","Object","keys","fragments","map","fragmentName","variableDefinitions","name","rawRequest","document","variables","variableValues","transforms","__spreadArrays","schema","mergeInfo","push","concat","isEnumType","returnType","processedRequest","applyRequestTransforms","skipValidation","errors","validate","_b","applyResultTransforms","execute","rootValue","context","apply","_c","sent","subscribe","executionResult","result","transformedResult","subscriptionKey","data","targetField","targetOperation","originalSelections","operationName","selections","forEach","field","fieldSelections","selectionSet","kind","Kind","SELECTION_SET","rootField","FIELD","alias","NAME","value","rootSelectionSet","operationDefinition","OPERATION_DEFINITION","DOCUMENT","definitions"],"sources":["../../src/stitching/delegateToSchema.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}